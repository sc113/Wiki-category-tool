## Wiki Category Tool

Графическая утилита для массовой работы со страницами проектов Wikimedia (в первую очередь — категорий). Позволяет:

- **Считывать содержимое страниц** и сохранять в TSV
- **Массово перезаписывать** существующие страницы из TSV
- **Массово создавать** новые страницы по TSV
- **Массово переименовывать** страницы (в т.ч. категории) по TSV

Работает через `pywikibot`, использует обычную учётную запись участника и соблюдает ограничения API (встроенный rate limiting, обработка 429).

### Ключевые возможности

- **Авторизация**: вход через `pywikibot`, выбор языка и проекта (Wikipedia, Commons и др.), отображение статуса допуска AWB; управление доступностью операций записи
- **Считать**: формирование списка страниц (через API или вручную), скачивание текста и сохранение в `*.tsv`
- **Перезаписать**: массовая запись текста на страницы из `*.tsv` (с поддержкой «Малой правки»)
- **Создать**: массовое создание новых страниц из `*.tsv`
- **Переименовать**: массовое переименование страниц по `*.tsv` с настройкой редиректов
- **Локальные префиксы NS**: автоматическая подгрузка префиксов пространств имён через API и кэширование. Режим «Авто» не меняет имена; при выборе конкретного NS подставляется локальный основной префикс
- **Интеграция с PetScan**: Ctrl+клик по «Получить» откроет преднастроенный запрос в браузере
- **Отладка**: окно логов, цветовые статусы, диагностика ошибок

### Поддерживаемые проекты

- Основные: `wikipedia`, `commons`
- Дополнительно (частично протестировано): `wikibooks`, `wiktionary`, `wikiquote`, `wikisource`, `wikiversity`, `species`, `wikidata`, `wikifunctions`, `wikivoyage`, `wikinews`, `meta`, `mediawiki`

## Зависимости и запуск (кратко)

- Python 3.10+; зависимости: `PySide6`, `pywikibot`, `requests`
- Запуск: `python wikicat_tool/wiki_cat_tool_qt.py`
- Для Windows есть портативный `.exe` (см. ниже)

## Портативная сборка (Windows, .exe)

- Один файл `.exe`, установка не нужна; Windows 10/11 x64
- При первом запуске создаётся `configs` рядом с `.exe`
- Создаваемые файлы (рядом с `.exe`):
  - `configs/user-config.py`: конфиг `pywikibot` (family, mylang, usernames по языкам)
  - `configs/user-password.py`: пара `(username, password)` для `pywikibot` (в открытом виде)
  - `configs/pywikibot-<username>.lwp` / `configs/pywikibot.lwp`: куки аутентификации для сессий
  - `configs/throttle.ctrl`: маркер подсистемы троттлинга `pywikibot`
  - `configs/apicache/*`: кэш ответов API (siteinfo и пр.)
  - `configs/ns_<project>_<lang>.json`: кэш локальных префиксов пространств имён
  - `configs/awb_bypass.key` (опц.): токен для отладки обхода требований AWB-доступа
- Нужна запись в каталог рядом с `.exe`
- Распространение `.exe`: приложите исходники (или ссылку), `LICENSE` и тексты сторонних лицензий

## Использование

- «Считать»: список страниц → TSV с текстом; «Перезаписать/Создать/Переименовать»: операции по TSV
- Для записи нужен допуск AWB на целевой вики

## Форматы файлов

### Результат считывания (Считать → .tsv)

- Кодировка: UTF‑8 BOM (utf‑8‑sig)
- Разделитель: TAB
- Структура: первая колонка — заголовок страницы, далее каждая строка её текста отдельной ячейкой
- Пример:

```
Категория:Физика	Первая строка текста	Вторая строка текста
```

### Перезаписать (входной .tsv)

- Формат: `Title<TAB>line1<TAB>line2…`
- Каждая строка файла — одна страница
- Итоговый текст страницы: `line1\nline2\n…`
- Пример:

```
Категория:Физика	Первая строка текста	Вторая строка текста
```

- Опции:
  - **Префиксы**: «Авто» оставляет заголовки как есть; выбранный NS — добавляет локальный префикс
  - **Малая правка (minor edit)**: сохраняет правки как minor

### Создать (входной .tsv)

- Формат: `Title<TAB>line1<TAB>line2…` (одна строка — одна новая страница)
- Minor для создания не применяется
- Пример:

```
Категория:Новые категории	Строка 1	Строка 2
```

### Переименовать (входной .tsv)

- Формат: `OldTitle<TAB>NewTitle<TAB>Reason`
- Опции редиректов:
  - «Оставлять редирект для категорий»
  - «Оставлять редирект для других страниц»
- Важно: переименовываются только названия категорий; перенос содержимого делается вручную (при необходимости)
- Пример:

```
Категория:Старое имя	Категория:Новое имя	Унификация наименования
```

## Работа с префиксами и пространствами имён

- Локальные префиксы NS автоматически подгружаются через `siteinfo` и кэшируются
- Режим «Авто» не меняет имена
- При выборе конкретного NS к заголовкам добавляется локальный основной префикс; уже проставленные английские префиксы (`Category:`, `Template:` и т.п.) распознаются и корректно нормализуются

## Доступ AWB и безопасный режим

- Операции записи («Перезаписать», «Создать», «Переименовать») доступны при наличии допуска AWB на выбранной вики
- Проверка идёт по странице `Project:AutoWikiBrowser/CheckPageJSON` проекта/языка
- Если страница отсутствует — доступ считается разрешённым
- Если вы не включены в списки `enabledusers/enabledbots`, запись будет заблокирована приложением
- **Режим обхода (для отладки/офлайн‑тестов)**:
  - Файл `configs/awb_bypass.key` с единственной строкой‑токеном
  - Или переменная окружения `BYPASS_AWB_TOKEN`
  - Автозапуск обхода: `BYPASS_AWB_AUTO=1`
  - Внимание: используйте обход ответственно. Он отключает клиентский барьер безопасности

## Отладка и лог

- Кнопка «Debug» открывает окно лога
- Лог выделяет цветом ошибки и статусы («записано/создано/переименована»)
- Сообщения `PYWIKIBOT:` помогают диагностировать авторизацию и обращения к API

## Конфиги, куки и кэш

Все служебные файлы — в папке `configs` рядом с исполняемым файлом/скриптом:

- `user-config.py`, `user-password.py` — параметры `pywikibot`
- Куки: `pywikibot-<username>.lwp` / `pywikibot.lwp`
- `throttle.ctrl` — файл подсистемы троттлинга `pywikibot`
- Кэш префиксов NS: `configs/apicache/…` и JSON для популярных вики

Безопасность: `user-password.py` хранит пароль в открытом виде; храните `configs` в защищённом месте.

## Политика запросов и устойчивость

- Все HTTP‑запросы выполняются через общую `requests.Session`
- Глобальный минимальный интервал между запросами и экспоненциальный backoff при 429
- JSON‑ответы валидируются, ошибки пишутся в лог

## Сборка дистрибутива (Windows)

В репозитории есть `wikicat_tool/wiki_cat_tool_qt.spec` для PyInstaller.

```bash
pip install pyinstaller
pyinstaller --noconfirm wikicat_tool/wiki_cat_tool_qt.spec
```

На выходе будет EXE; папка `configs` создастся автоматически при первом запуске.

## Советы по использованию

- Для предварительного отбора подкатегорий используйте Ctrl+клик по «Получить» — откроется PetScan
- Перед массовыми правками проверьте несколько примеров вручную
- Всегда указывайте понятный «Комментарий к правкам» — это поможет патрулирующим
- Для проектов вне Wikipedia тестируйте на небольших наборах

## Ограничения и дисклеймер

- Ответственность за массовые изменения несёт оператор. Соблюдайте правила локальных сообществ
- Для некоторых проектов/языков локальные префиксы или страницы допуска AWB могут работать иначе; проверяйте логи
- Функции вне Wikipedia поддерживаются частично

## Лицензия

**Лицензия:** GPL‑3.0‑or‑later. При распространении бинарников предоставляйте исходники и сохраняйте условия лицензии (см. `LICENSE`). Сторонние компоненты — по своим лицензиям (напр., PySide6/Qt — LGPL‑3.0).


